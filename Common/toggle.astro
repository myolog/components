---
import type { HTMLAttributes } from "astro/types";
import { cva, type VariantProps } from "class-variance-authority";

// 1. CVA 정의 (data-[state=on]을 그대로 사용)
export const toggleVariants = cva(
  "inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium hover:bg-muted hover:text-muted-foreground disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 [&_svg]:shrink-0 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] outline-none transition-[color,box-shadow] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive whitespace-nowrap",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline:
          "border border-input bg-transparent hover:bg-accent hover:text-accent-foreground",
      },
      size: {
        default: "h-9 px-2 min-w-9",
        sm: "h-8 px-1.5 min-w-8",
        lg: "h-10 px-2.5 min-w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

export interface Props
  extends HTMLAttributes<"button">,
    VariantProps<typeof toggleVariants> {
  defaultPressed?: boolean;
}

const {
  variant,
  size,
  class: className,
  defaultPressed = false,
  ...props
} = Astro.props;

const classes = toggleVariants({ variant, size, className });
---

<button
  type="button"
  class:list={classes}
  data-astro-toggle aria-pressed={defaultPressed ? "true" : "false"}
  data-state={defaultPressed ? "on" : "off"}
  {...props}
>
  <slot />
</button>

<script>
  const toggleButtons = document.querySelectorAll(
    "button[data-astro-toggle]",
  );

  toggleButtons.forEach((button) => {
    // 스크립트 중복 실행 방지
    //@ts-ignore
    if (button.dataset.listenerAttached) return;
    //@ts-ignore
    button.dataset.listenerAttached = "true";

    button.addEventListener("click", () => {
      if (button.hasAttribute("disabled")) return;

      const isPressed = button.getAttribute("aria-pressed") === "true";
      const newState = !isPressed;

      // ARIA 속성 업데이트
      button.setAttribute("aria-pressed", newState ? "true" : "false");
      
      // CVA 스타일링을 위한 'data-state' 속성 업데이트
      button.setAttribute("data-state", newState ? "on" : "off");
    });
  });
</script>